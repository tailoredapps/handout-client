'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _expandHomeDir = require('expand-home-dir');

var _expandHomeDir2 = _interopRequireDefault(_expandHomeDir);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _ursa = require('ursa');

var _ursa2 = _interopRequireDefault(_ursa);

var _ws = require('ws');

var _ws2 = _interopRequireDefault(_ws);

var _output = require('output');

var _output2 = _interopRequireDefault(_output);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var WebsocketClient = function () {
  function WebsocketClient(opts) {
    _classCallCheck(this, WebsocketClient);

    this.opts = opts;
  }

  _createClass(WebsocketClient, [{
    key: 'connect',
    value: function connect() {
      var _this = this;

      return new _bluebird2.default(function (resolve, reject) {
        var url = _this.opts.url;

        _this.socket = new _ws2.default(url);
        _this.socket.on('open', function () {
          return resolve(_this.socket);
        });

        _this.socket.on('message', function (data) {
          try {
            var _JSON$parse = JSON.parse(data);

            var level = _JSON$parse.level;
            var message = _JSON$parse.message;
            var error = _JSON$parse.error;

            (0, _output2.default)(message, error ? _output.LEVEL_ERROR : level, true);
          } catch (e) {
            (0, _output2.default)('Failed to parse server response. Something weird might be happening. Error message: ' + e.message, _output.LEVEL_ERROR);
            (0, _output2.default)('  Raw server response: ' + data);
          }
        });

        _this.socket.on('close', function (code, message) {
          if (code > 1000) {
            (0, _output2.default)('Deployment failed with code ' + _output.outputStyles.error(code) + '.', _output.LEVEL_ERROR);
          } else {
            (0, _output2.default)('Deployment completed, closing connection to ' + _output.outputStyles.url(url) + '.', _output.LEVEL_OK);
          }

          if (message) {
            (0, _output2.default)('  Socket close message: ' + message);
          }

          // if (code > 1000) {
          //    process.exit(1)
          // }
        });

        _this.socket.on('error', function (err) {
          return reject(err);
        });
      });
    }
  }, {
    key: 'sendCommand',
    value: function sendCommand(_ref) {
      var command = _ref.command;
      var keyfile = _ref.keyfile;
      var payload = _ref.payload;
      var debug = _ref.debug;
      var username = this.opts.username;

      (0, _output2.default)(this.getInfoMessage(command, payload));

      if (debug) {
        (0, _output2.default)('Reading private key file ' + keyfile + '.', _output.LEVEL_DEBUG);
      }

      var privKey = _ursa2.default.createPrivateKey(_fs2.default.readFileSync((0, _expandHomeDir2.default)(keyfile), { encoding: 'utf8' }));

      if (debug) {
        (0, _output2.default)('Private key file read. Encrypting command.', _output.LEVEL_DEBUG);
      }

      var cryptStr = privKey.privateEncrypt(JSON.stringify({ command: command, payload: payload }));

      this.socket.send(JSON.stringify({ username: username, debug: debug, cryptStr: cryptStr }));
    }
  }, {
    key: 'getInfoMessage',
    value: function getInfoMessage(command, payload) {
      var username = this.opts.username;

      switch (command) {
        case 'deploy':
          var app = payload.app;
          var targets = payload.targets;

          return 'Sending request to deploy ' + _output.outputStyles.app(app) + ' as user ' + _output.outputStyles.username(username) + ' to targets: ' + targets.map(function (t) {
            return _output.outputStyles.target(t);
          }).join(', ') + '.';

        case 'user':
          var action = payload.action;
          var accountname = payload.accountname;

          var targetAccount = _output.outputStyles.target(accountname);

          var msg = new Map([['create', 'to create user ' + targetAccount], ['add-pubkey', 'add public key to account ' + targetAccount], ['remove-pubkey', 'remove public key from account ' + targetAccount], ['remove', 'remove account ' + targetAccount]]);

          return 'Sending request to ' + msg.get(action) + '.';
      }
    }
  }]);

  return WebsocketClient;
}();

exports.default = WebsocketClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ub2RlX21vZHVsZXMvV2Vic29ja2V0Q2xpZW50LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7SUFVTTtBQUNKLFdBREksZUFDSixDQUFhLElBQWIsRUFBbUI7MEJBRGYsaUJBQ2U7O0FBQ2pCLFNBQUssSUFBTCxHQUFZLElBQVosQ0FEaUI7R0FBbkI7O2VBREk7OzhCQUtPOzs7QUFDVCxhQUFPLHVCQUFZLFVBQUMsT0FBRCxFQUFVLE1BQVYsRUFBcUI7WUFDL0IsTUFBTyxNQUFLLElBQUwsQ0FBUCxJQUQrQjs7QUFHdEMsY0FBSyxNQUFMLEdBQWMsaUJBQWMsR0FBZCxDQUFkLENBSHNDO0FBSXRDLGNBQUssTUFBTCxDQUFZLEVBQVosQ0FBZSxNQUFmLEVBQXVCO2lCQUFNLFFBQVEsTUFBSyxNQUFMO1NBQWQsQ0FBdkIsQ0FKc0M7O0FBTXRDLGNBQUssTUFBTCxDQUFZLEVBQVosQ0FBZSxTQUFmLEVBQTBCLFVBQUMsSUFBRCxFQUFVO0FBQ2xDLGNBQUk7OEJBQzhCLEtBQUssS0FBTCxDQUFXLElBQVgsRUFEOUI7O2dCQUNLLDBCQURMO2dCQUNZLDhCQURaO2dCQUNxQiwwQkFEckI7O0FBR0Ysa0NBQU8sT0FBUCxFQUFnQixnQkFsQkksV0FrQkosR0FBc0IsS0FBdEIsRUFBNkIsSUFBN0MsRUFIRTtXQUFKLENBSUUsT0FBTyxDQUFQLEVBQVU7QUFDViwySEFBOEYsRUFBRSxPQUFGLFVBcEIxRSxXQW9CcEIsRUFEVTtBQUVWLDhEQUFpQyxJQUFqQyxFQUZVO1dBQVY7U0FMc0IsQ0FBMUIsQ0FOc0M7O0FBaUJ0QyxjQUFLLE1BQUwsQ0FBWSxFQUFaLENBQWUsT0FBZixFQUF3QixVQUFDLElBQUQsRUFBTyxPQUFQLEVBQW1CO0FBQ3pDLGNBQUksT0FBTyxJQUFQLEVBQWE7QUFDZixtRUFBc0MsUUEzQkssWUEyQkwsQ0FBYSxLQUFiLENBQW1CLElBQW5CLE9BQXRDLFVBM0JvQixXQTJCcEIsRUFEZTtXQUFqQixNQUVPO0FBQ0wsbUZBQXNELFFBN0JYLFlBNkJXLENBQWEsR0FBYixDQUFpQixHQUFqQixPQUF0RCxVQTdCaUMsUUE2QmpDLEVBREs7V0FGUDs7QUFNQSxjQUFJLE9BQUosRUFBYTtBQUNYLCtEQUFrQyxPQUFsQyxFQURXO1dBQWI7Ozs7O0FBUHlDLFNBQW5CLENBQXhCLENBakJzQzs7QUFpQ3RDLGNBQUssTUFBTCxDQUFZLEVBQVosQ0FBZSxPQUFmLEVBQXdCO2lCQUFPLE9BQU8sR0FBUDtTQUFQLENBQXhCLENBakNzQztPQUFyQixDQUFuQixDQURTOzs7O3NDQXNDd0M7VUFBcEMsdUJBQW9DO1VBQTNCLHVCQUEyQjtVQUFsQix1QkFBa0I7VUFBVCxtQkFBUztVQUMxQyxXQUFZLEtBQUssSUFBTCxDQUFaLFNBRDBDOztBQUdqRCw0QkFBTyxLQUFLLGNBQUwsQ0FBb0IsT0FBcEIsRUFBNkIsT0FBN0IsQ0FBUCxFQUhpRDs7QUFLakQsVUFBSSxLQUFKLEVBQVc7QUFDVCw0REFBbUMsYUFBbkMsVUFuRFcsV0FtRFgsRUFEUztPQUFYOztBQUlBLFVBQU0sVUFBVSxlQUFLLGdCQUFMLENBQXNCLGFBQUcsWUFBSCxDQUFnQiw2QkFBYyxPQUFkLENBQWhCLEVBQXdDLEVBQUUsVUFBVSxNQUFWLEVBQTFDLENBQXRCLENBQVYsQ0FUMkM7O0FBV2pELFVBQUksS0FBSixFQUFXO0FBQ1Qsb0ZBekRXLFdBeURYLEVBRFM7T0FBWDs7QUFJQSxVQUFNLFdBQVcsUUFBUSxjQUFSLENBQXVCLEtBQUssU0FBTCxDQUFlLEVBQUUsZ0JBQUYsRUFBVyxnQkFBWCxFQUFmLENBQXZCLENBQVgsQ0FmMkM7O0FBaUJqRCxXQUFLLE1BQUwsQ0FBWSxJQUFaLENBQWlCLEtBQUssU0FBTCxDQUFlLEVBQUUsa0JBQUYsRUFBWSxZQUFaLEVBQW1CLGtCQUFuQixFQUFmLENBQWpCLEVBakJpRDs7OzttQ0FvQm5DLFNBQVMsU0FBUztVQUN6QixXQUFZLEtBQUssSUFBTCxDQUFaLFNBRHlCOztBQUdoQyxjQUFRLE9BQVI7QUFDRSxhQUFLLFFBQUw7Y0FDVSxNQUFpQixRQUFqQixJQURWO2NBQ2UsVUFBWSxRQUFaLFFBRGY7O0FBRUUsZ0RBQW9DLFFBdkVTLFlBdUVULENBQWEsR0FBYixDQUFpQixHQUFqQixrQkFBaUMsUUF2RXhCLFlBdUV3QixDQUFhLFFBQWIsQ0FBc0IsUUFBdEIsc0JBQStDLFFBQVEsR0FBUixDQUFZO21CQUFLLFFBdkV4RixZQXVFd0YsQ0FBYSxNQUFiLENBQW9CLENBQXBCO1dBQUwsQ0FBWixDQUF5QyxJQUF6QyxDQUE4QyxJQUE5QyxPQUFwSCxDQUZGOztBQURGLGFBS08sTUFBTDtjQUNVLFNBQXdCLFFBQXhCLE9BRFY7Y0FDa0IsY0FBZ0IsUUFBaEIsWUFEbEI7O0FBRUUsY0FBTSxnQkFBZ0IsUUEzRXVCLFlBMkV2QixDQUFhLE1BQWIsQ0FBb0IsV0FBcEIsQ0FBaEIsQ0FGUjs7QUFJRSxjQUFNLE1BQU0sSUFBSSxHQUFKLENBQVEsQ0FDbEIsQ0FBRSxRQUFGLHNCQUE4QixhQUE5QixDQURrQixFQUVsQixDQUFFLFlBQUYsaUNBQTZDLGFBQTdDLENBRmtCLEVBR2xCLENBQUUsZUFBRixzQ0FBcUQsYUFBckQsQ0FIa0IsRUFJbEIsQ0FBRSxRQUFGLHNCQUE4QixhQUE5QixDQUprQixDQUFSLENBQU4sQ0FKUjs7QUFXRSx5Q0FBNkIsSUFBSSxHQUFKLENBQVEsTUFBUixPQUE3QixDQVhGO0FBTEYsT0FIZ0M7Ozs7U0EvRDlCOzs7a0JBdUZTIiwiZmlsZSI6IldlYnNvY2tldENsaWVudC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0J1xuXG5pbXBvcnQgZXhwYW5kSG9tZURpciBmcm9tICdleHBhbmQtaG9tZS1kaXInXG5pbXBvcnQgZnMgZnJvbSAnZnMnXG5pbXBvcnQgUHJvbWlzZSBmcm9tICdibHVlYmlyZCdcbmltcG9ydCB1cnNhIGZyb20gJ3Vyc2EnXG5pbXBvcnQgV2Vic29ja2V0IGZyb20gJ3dzJ1xuXG5pbXBvcnQgb3V0cHV0LCB7IExFVkVMX0RFQlVHLCBMRVZFTF9FUlJPUiwgTEVWRUxfT0ssIG91dHB1dFN0eWxlc30gZnJvbSAnb3V0cHV0J1xuXG5jbGFzcyBXZWJzb2NrZXRDbGllbnQge1xuICBjb25zdHJ1Y3RvciAob3B0cykge1xuICAgIHRoaXMub3B0cyA9IG9wdHNcbiAgfVxuXG4gIGNvbm5lY3QgKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCB7dXJsfSA9IHRoaXMub3B0c1xuXG4gICAgICB0aGlzLnNvY2tldCA9IG5ldyBXZWJzb2NrZXQodXJsKVxuICAgICAgdGhpcy5zb2NrZXQub24oJ29wZW4nLCAoKSA9PiByZXNvbHZlKHRoaXMuc29ja2V0KSlcblxuICAgICAgdGhpcy5zb2NrZXQub24oJ21lc3NhZ2UnLCAoZGF0YSkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHtsZXZlbCwgbWVzc2FnZSwgZXJyb3J9ID0gSlNPTi5wYXJzZShkYXRhKVxuXG4gICAgICAgICAgb3V0cHV0KG1lc3NhZ2UsIGVycm9yID8gTEVWRUxfRVJST1IgOiBsZXZlbCwgdHJ1ZSlcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIG91dHB1dChgRmFpbGVkIHRvIHBhcnNlIHNlcnZlciByZXNwb25zZS4gU29tZXRoaW5nIHdlaXJkIG1pZ2h0IGJlIGhhcHBlbmluZy4gRXJyb3IgbWVzc2FnZTogJHtlLm1lc3NhZ2V9YCwgTEVWRUxfRVJST1IpXG4gICAgICAgICAgb3V0cHV0KGAgIFJhdyBzZXJ2ZXIgcmVzcG9uc2U6ICR7ZGF0YX1gKVxuICAgICAgICB9XG4gICAgICB9KVxuXG4gICAgICB0aGlzLnNvY2tldC5vbignY2xvc2UnLCAoY29kZSwgbWVzc2FnZSkgPT4ge1xuICAgICAgICBpZiAoY29kZSA+IDEwMDApIHtcbiAgICAgICAgICBvdXRwdXQoYERlcGxveW1lbnQgZmFpbGVkIHdpdGggY29kZSAke291dHB1dFN0eWxlcy5lcnJvcihjb2RlKX0uYCwgTEVWRUxfRVJST1IpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgb3V0cHV0KGBEZXBsb3ltZW50IGNvbXBsZXRlZCwgY2xvc2luZyBjb25uZWN0aW9uIHRvICR7b3V0cHV0U3R5bGVzLnVybCh1cmwpfS5gLCBMRVZFTF9PSylcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChtZXNzYWdlKSB7XG4gICAgICAgICAgb3V0cHV0KGAgIFNvY2tldCBjbG9zZSBtZXNzYWdlOiAke21lc3NhZ2V9YClcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGlmIChjb2RlID4gMTAwMCkge1xuICAgICAgICAvLyAgICBwcm9jZXNzLmV4aXQoMSlcbiAgICAgICAgLy8gfVxuICAgICAgfSlcblxuICAgICAgdGhpcy5zb2NrZXQub24oJ2Vycm9yJywgZXJyID0+IHJlamVjdChlcnIpKVxuICAgIH0pXG4gIH1cblxuICBzZW5kQ29tbWFuZCAoeyBjb21tYW5kLCBrZXlmaWxlLCBwYXlsb2FkLCBkZWJ1ZyB9KSB7XG4gICAgY29uc3Qge3VzZXJuYW1lfSA9IHRoaXMub3B0c1xuXG4gICAgb3V0cHV0KHRoaXMuZ2V0SW5mb01lc3NhZ2UoY29tbWFuZCwgcGF5bG9hZCkpXG5cbiAgICBpZiAoZGVidWcpIHtcbiAgICAgIG91dHB1dChgUmVhZGluZyBwcml2YXRlIGtleSBmaWxlICR7a2V5ZmlsZX0uYCwgTEVWRUxfREVCVUcpXG4gICAgfVxuXG4gICAgY29uc3QgcHJpdktleSA9IHVyc2EuY3JlYXRlUHJpdmF0ZUtleShmcy5yZWFkRmlsZVN5bmMoZXhwYW5kSG9tZURpcihrZXlmaWxlKSwgeyBlbmNvZGluZzogJ3V0ZjgnIH0pKVxuXG4gICAgaWYgKGRlYnVnKSB7XG4gICAgICBvdXRwdXQoYFByaXZhdGUga2V5IGZpbGUgcmVhZC4gRW5jcnlwdGluZyBjb21tYW5kLmAsIExFVkVMX0RFQlVHKVxuICAgIH1cblxuICAgIGNvbnN0IGNyeXB0U3RyID0gcHJpdktleS5wcml2YXRlRW5jcnlwdChKU09OLnN0cmluZ2lmeSh7IGNvbW1hbmQsIHBheWxvYWQgfSkpXG5cbiAgICB0aGlzLnNvY2tldC5zZW5kKEpTT04uc3RyaW5naWZ5KHsgdXNlcm5hbWUsIGRlYnVnLCBjcnlwdFN0ciB9KSlcbiAgfVxuXG4gIGdldEluZm9NZXNzYWdlIChjb21tYW5kLCBwYXlsb2FkKSB7XG4gICAgY29uc3Qge3VzZXJuYW1lfSA9IHRoaXMub3B0c1xuXG4gICAgc3dpdGNoIChjb21tYW5kKSB7XG4gICAgICBjYXNlICdkZXBsb3knOlxuICAgICAgICBjb25zdCB7IGFwcCwgdGFyZ2V0cyB9ID0gcGF5bG9hZFxuICAgICAgICByZXR1cm4gYFNlbmRpbmcgcmVxdWVzdCB0byBkZXBsb3kgJHtvdXRwdXRTdHlsZXMuYXBwKGFwcCl9IGFzIHVzZXIgJHtvdXRwdXRTdHlsZXMudXNlcm5hbWUodXNlcm5hbWUpfSB0byB0YXJnZXRzOiAke3RhcmdldHMubWFwKHQgPT4gb3V0cHV0U3R5bGVzLnRhcmdldCh0KSkuam9pbignLCAnKX0uYFxuXG4gICAgICBjYXNlICd1c2VyJzpcbiAgICAgICAgY29uc3QgeyBhY3Rpb24sIGFjY291bnRuYW1lIH0gPSBwYXlsb2FkXG4gICAgICAgIGNvbnN0IHRhcmdldEFjY291bnQgPSBvdXRwdXRTdHlsZXMudGFyZ2V0KGFjY291bnRuYW1lKVxuXG4gICAgICAgIGNvbnN0IG1zZyA9IG5ldyBNYXAoW1xuICAgICAgICAgIFsgJ2NyZWF0ZScsIGB0byBjcmVhdGUgdXNlciAke3RhcmdldEFjY291bnR9YCBdLFxuICAgICAgICAgIFsgJ2FkZC1wdWJrZXknLCBgYWRkIHB1YmxpYyBrZXkgdG8gYWNjb3VudCAke3RhcmdldEFjY291bnR9YCBdLFxuICAgICAgICAgIFsgJ3JlbW92ZS1wdWJrZXknLCBgcmVtb3ZlIHB1YmxpYyBrZXkgZnJvbSBhY2NvdW50ICR7dGFyZ2V0QWNjb3VudH1gIF0sXG4gICAgICAgICAgWyAncmVtb3ZlJywgYHJlbW92ZSBhY2NvdW50ICR7dGFyZ2V0QWNjb3VudH1gIF1cbiAgICAgICAgXSlcblxuICAgICAgICByZXR1cm4gYFNlbmRpbmcgcmVxdWVzdCB0byAke21zZy5nZXQoYWN0aW9uKX0uYFxuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBXZWJzb2NrZXRDbGllbnRcbiJdfQ==