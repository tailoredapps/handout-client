'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _expandHomeDir = require('expand-home-dir');

var _expandHomeDir2 = _interopRequireDefault(_expandHomeDir);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _ursa = require('ursa');

var _ursa2 = _interopRequireDefault(_ursa);

var _ws = require('ws');

var _ws2 = _interopRequireDefault(_ws);

var _output = require('output');

var _output2 = _interopRequireDefault(_output);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectWithoutProperties(obj, keys) { var target = {}; for (var i in obj) { if (keys.indexOf(i) >= 0) continue; if (!Object.prototype.hasOwnProperty.call(obj, i)) continue; target[i] = obj[i]; } return target; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var WebsocketClient = function () {
  function WebsocketClient(opts) {
    _classCallCheck(this, WebsocketClient);

    this.opts = opts;
  }

  _createClass(WebsocketClient, [{
    key: 'connect',
    value: regeneratorRuntime.mark(function connect() {
      var _this = this;

      return regeneratorRuntime.wrap(function connect$(_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              return _context.abrupt('return', new _bluebird2.default(function (resolve, reject) {
                var url = _this.opts.url;

                _this.socket = new _ws2.default(url);
                _this.socket.on('open', function () {
                  return resolve(_this.socket);
                });

                _this.socket.on('message', function (data) {
                  try {
                    var _JSON$parse = JSON.parse(data);

                    var level = _JSON$parse.level;
                    var message = _JSON$parse.message;
                    var error = _JSON$parse.error;

                    (0, _output2.default)(message, error ? _output.LEVEL_ERROR : level, true);
                  } catch (e) {
                    (0, _output2.default)('Failed to parse server response. Something weird might be happening. Error message: ' + e.message, _output.LEVEL_ERROR);
                    (0, _output2.default)('  Raw server response: ' + data);
                  }
                });

                _this.socket.on('close', function (code, message) {
                  if (code > 1000) {
                    (0, _output2.default)('Deployment failed with code ' + _output.outputStyles.error(code) + '.', _output.LEVEL_ERROR);
                  } else {
                    (0, _output2.default)('Deployment completed, closing connection to ' + _output.outputStyles.url(url) + '.', _output.LEVEL_OK);
                  }

                  if (message) {
                    (0, _output2.default)('  Socket close message: ' + message);
                  }

                  // if (code > 1000) {
                  //    process.exit(1)
                  // }
                });

                _this.socket.on('error', function (err) {
                  return reject(err);
                });
              }));

            case 1:
            case 'end':
              return _context.stop();
          }
        }
      }, connect, this);
    })
  }, {
    key: 'sendCommand',
    value: regeneratorRuntime.mark(function sendCommand(opts) {
      var username, keyfile, cmd, privKey, cryptStr;
      return regeneratorRuntime.wrap(function sendCommand$(_context2) {
        while (1) {
          switch (_context2.prev = _context2.next) {
            case 0:
              username = this.opts.username;
              keyfile = opts.keyfile;
              cmd = _objectWithoutProperties(opts, ['keyfile']);

              (0, _output2.default)('Sending request to deploy ' + _output.outputStyles.app(cmd.app) + ' as user ' + _output.outputStyles.username(username) + ' to targets: ' + cmd.targets.map(function (t) {
                return _output.outputStyles.target(t);
              }).join(', ') + '.');

              privKey = _ursa2.default.createPrivateKey(_fs2.default.readFileSync((0, _expandHomeDir2.default)(keyfile), { encoding: 'utf8' }));
              cryptStr = privKey.privateEncrypt(JSON.stringify(cmd));

              this.socket.send(JSON.stringify({ username: username, cryptStr: cryptStr }));

            case 7:
            case 'end':
              return _context2.stop();
          }
        }
      }, sendCommand, this);
    })
  }]);

  return WebsocketClient;
}();

exports.default = WebsocketClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ub2RlX21vZHVsZXMvV2Vic29ja2V0Q2xpZW50LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7SUFVTixlQUFlO0FBQ25CLFdBREksZUFBZSxDQUNOLElBQUksRUFBRTswQkFEZixlQUFlOztBQUVqQixRQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQTtHQUNqQjs7ZUFIRyxlQUFlOzs7Ozs7Ozs7K0NBTVYsdUJBQVksVUFBQyxPQUFPLEVBQUUsTUFBTSxFQUFLO29CQUMvQixHQUFHLEdBQUksTUFBSyxJQUFJLENBQWhCLEdBQUc7O0FBRVYsc0JBQUssTUFBTSxHQUFHLGlCQUFjLEdBQUcsQ0FBQyxDQUFBO0FBQ2hDLHNCQUFLLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFO3lCQUFNLE9BQU8sQ0FBQyxNQUFLLE1BQU0sQ0FBQztpQkFBQSxDQUFDLENBQUE7O0FBRWxELHNCQUFLLE1BQU0sQ0FBQyxFQUFFLENBQUMsU0FBUyxFQUFFLFVBQUMsSUFBSSxFQUFLO0FBQ2xDLHNCQUFJO3NDQUM4QixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQzs7d0JBQXpDLEtBQUssZUFBTCxLQUFLO3dCQUFFLE9BQU8sZUFBUCxPQUFPO3dCQUFFLEtBQUssZUFBTCxLQUFLOztBQUU1QiwwQ0FBTyxPQUFPLEVBQUUsS0FBSyx5QkFBaUIsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFBO21CQUNuRCxDQUFDLE9BQU8sQ0FBQyxFQUFFO0FBQ1YsbUlBQThGLENBQUMsQ0FBQyxPQUFPLHNCQUFnQixDQUFBO0FBQ3ZILHNFQUFpQyxJQUFJLENBQUcsQ0FBQTttQkFDekM7aUJBQ0YsQ0FBQyxDQUFBOztBQUVGLHNCQUFLLE1BQU0sQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLFVBQUMsSUFBSSxFQUFFLE9BQU8sRUFBSztBQUN6QyxzQkFBSSxJQUFJLEdBQUcsSUFBSSxFQUFFO0FBQ2YsMkVBQXNDLHFCQUFhLEtBQUssQ0FBQyxJQUFJLENBQUMsNEJBQWlCLENBQUE7bUJBQ2hGLE1BQU07QUFDTCwyRkFBc0QscUJBQWEsR0FBRyxDQUFDLEdBQUcsQ0FBQyx5QkFBYyxDQUFBO21CQUMxRjs7QUFFRCxzQkFBSSxPQUFPLEVBQUU7QUFDWCx1RUFBa0MsT0FBTyxDQUFHLENBQUE7bUJBQzdDOzs7OztBQUFBLGlCQUtGLENBQUMsQ0FBQTs7QUFFRixzQkFBSyxNQUFNLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxVQUFBLEdBQUc7eUJBQUksTUFBTSxDQUFDLEdBQUcsQ0FBQztpQkFBQSxDQUFDLENBQUE7ZUFDNUMsQ0FBQzs7Ozs7Ozs7Ozs7d0RBR1csSUFBSTtVQUNWLFFBQVEsRUFDUixPQUFPLEVBQUssR0FBRyxFQUloQixPQUFPLEVBQ1AsUUFBUTs7Ozs7QUFOUCxzQkFBUSxHQUFJLElBQUksQ0FBQyxJQUFJLENBQXJCLFFBQVE7QUFDUixxQkFBTyxHQUFZLElBQUksQ0FBdkIsT0FBTztBQUFLLGlCQUFHLDRCQUFJLElBQUk7O0FBRTlCLG1FQUFvQyxxQkFBYSxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxpQkFBWSxxQkFBYSxRQUFRLENBQUMsUUFBUSxDQUFDLHFCQUFnQixHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFBLENBQUM7dUJBQUkscUJBQWEsTUFBTSxDQUFDLENBQUMsQ0FBQztlQUFBLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQUksQ0FBQTs7QUFFN0sscUJBQU8sR0FBRyxlQUFLLGdCQUFnQixDQUFDLGFBQUcsWUFBWSxDQUFDLDZCQUFjLE9BQU8sQ0FBQyxFQUFFLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7QUFDOUYsc0JBQVEsR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7O0FBRTVELGtCQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsUUFBUSxFQUFSLFFBQVEsRUFBRSxRQUFRLEVBQVIsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFBOzs7Ozs7Ozs7OztTQXBEdEQsZUFBZTs7O2tCQXdETixlQUFlIiwiZmlsZSI6IldlYnNvY2tldENsaWVudC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0J1xuXG5pbXBvcnQgZXhwYW5kSG9tZURpciBmcm9tICdleHBhbmQtaG9tZS1kaXInXG5pbXBvcnQgZnMgZnJvbSAnZnMnXG5pbXBvcnQgUHJvbWlzZSBmcm9tICdibHVlYmlyZCdcbmltcG9ydCB1cnNhIGZyb20gJ3Vyc2EnXG5pbXBvcnQgV2Vic29ja2V0IGZyb20gJ3dzJ1xuXG5pbXBvcnQgb3V0cHV0LCB7TEVWRUxfRVJST1IsIExFVkVMX09LLCBvdXRwdXRTdHlsZXN9IGZyb20gJ291dHB1dCdcblxuY2xhc3MgV2Vic29ja2V0Q2xpZW50IHtcbiAgY29uc3RydWN0b3IgKG9wdHMpIHtcbiAgICB0aGlzLm9wdHMgPSBvcHRzXG4gIH1cblxuICAqIGNvbm5lY3QgKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCB7dXJsfSA9IHRoaXMub3B0c1xuXG4gICAgICB0aGlzLnNvY2tldCA9IG5ldyBXZWJzb2NrZXQodXJsKVxuICAgICAgdGhpcy5zb2NrZXQub24oJ29wZW4nLCAoKSA9PiByZXNvbHZlKHRoaXMuc29ja2V0KSlcblxuICAgICAgdGhpcy5zb2NrZXQub24oJ21lc3NhZ2UnLCAoZGF0YSkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHtsZXZlbCwgbWVzc2FnZSwgZXJyb3J9ID0gSlNPTi5wYXJzZShkYXRhKVxuXG4gICAgICAgICAgb3V0cHV0KG1lc3NhZ2UsIGVycm9yID8gTEVWRUxfRVJST1IgOiBsZXZlbCwgdHJ1ZSlcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIG91dHB1dChgRmFpbGVkIHRvIHBhcnNlIHNlcnZlciByZXNwb25zZS4gU29tZXRoaW5nIHdlaXJkIG1pZ2h0IGJlIGhhcHBlbmluZy4gRXJyb3IgbWVzc2FnZTogJHtlLm1lc3NhZ2V9YCwgTEVWRUxfRVJST1IpXG4gICAgICAgICAgb3V0cHV0KGAgIFJhdyBzZXJ2ZXIgcmVzcG9uc2U6ICR7ZGF0YX1gKVxuICAgICAgICB9XG4gICAgICB9KVxuXG4gICAgICB0aGlzLnNvY2tldC5vbignY2xvc2UnLCAoY29kZSwgbWVzc2FnZSkgPT4ge1xuICAgICAgICBpZiAoY29kZSA+IDEwMDApIHtcbiAgICAgICAgICBvdXRwdXQoYERlcGxveW1lbnQgZmFpbGVkIHdpdGggY29kZSAke291dHB1dFN0eWxlcy5lcnJvcihjb2RlKX0uYCwgTEVWRUxfRVJST1IpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgb3V0cHV0KGBEZXBsb3ltZW50IGNvbXBsZXRlZCwgY2xvc2luZyBjb25uZWN0aW9uIHRvICR7b3V0cHV0U3R5bGVzLnVybCh1cmwpfS5gLCBMRVZFTF9PSylcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChtZXNzYWdlKSB7XG4gICAgICAgICAgb3V0cHV0KGAgIFNvY2tldCBjbG9zZSBtZXNzYWdlOiAke21lc3NhZ2V9YClcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGlmIChjb2RlID4gMTAwMCkge1xuICAgICAgICAvLyAgICBwcm9jZXNzLmV4aXQoMSlcbiAgICAgICAgLy8gfVxuICAgICAgfSlcblxuICAgICAgdGhpcy5zb2NrZXQub24oJ2Vycm9yJywgZXJyID0+IHJlamVjdChlcnIpKVxuICAgIH0pXG4gIH1cblxuICAqIHNlbmRDb21tYW5kIChvcHRzKSB7XG4gICAgY29uc3Qge3VzZXJuYW1lfSA9IHRoaXMub3B0c1xuICAgIGNvbnN0IHtrZXlmaWxlLCAuLi5jbWR9ID0gb3B0c1xuXG4gICAgb3V0cHV0KGBTZW5kaW5nIHJlcXVlc3QgdG8gZGVwbG95ICR7b3V0cHV0U3R5bGVzLmFwcChjbWQuYXBwKX0gYXMgdXNlciAke291dHB1dFN0eWxlcy51c2VybmFtZSh1c2VybmFtZSl9IHRvIHRhcmdldHM6ICR7Y21kLnRhcmdldHMubWFwKHQgPT4gb3V0cHV0U3R5bGVzLnRhcmdldCh0KSkuam9pbignLCAnKX0uYClcblxuICAgIGNvbnN0IHByaXZLZXkgPSB1cnNhLmNyZWF0ZVByaXZhdGVLZXkoZnMucmVhZEZpbGVTeW5jKGV4cGFuZEhvbWVEaXIoa2V5ZmlsZSksIHsgZW5jb2Rpbmc6ICd1dGY4JyB9KSlcbiAgICBjb25zdCBjcnlwdFN0ciA9IHByaXZLZXkucHJpdmF0ZUVuY3J5cHQoSlNPTi5zdHJpbmdpZnkoY21kKSlcblxuICAgIHRoaXMuc29ja2V0LnNlbmQoSlNPTi5zdHJpbmdpZnkoeyB1c2VybmFtZSwgY3J5cHRTdHIgfSkpXG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgV2Vic29ja2V0Q2xpZW50XG4iXX0=