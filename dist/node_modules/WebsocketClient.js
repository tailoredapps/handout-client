'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _crypto = require('crypto');

var _crypto2 = _interopRequireDefault(_crypto);

var _expandHomeDir = require('expand-home-dir');

var _expandHomeDir2 = _interopRequireDefault(_expandHomeDir);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _handoutConstants = require('handout-constants');

var _ursa = require('ursa');

var _ursa2 = _interopRequireDefault(_ursa);

var _ws = require('ws');

var _ws2 = _interopRequireDefault(_ws);

var _output = require('output');

var _output2 = _interopRequireDefault(_output);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var WebsocketClient = function () {
  function WebsocketClient(opts) {
    _classCallCheck(this, WebsocketClient);

    this.opts = opts;
    this._command = null;
  }

  _createClass(WebsocketClient, [{
    key: 'connect',
    value: function connect() {
      var _this = this;

      return new _bluebird2.default(function (resolve, reject) {
        var url = _this.opts.url;

        _this.socket = new _ws2.default(url);
        _this.socket.on('open', function () {
          return resolve(_this.socket);
        });

        _this.socket.on('message', function (data) {
          try {
            var _JSON$parse = JSON.parse(data);

            var level = _JSON$parse.level;
            var message = _JSON$parse.message;

            if (level === _handoutConstants.MSG_LEVEL_PROCESS) {
              (0, _output.processResponse)(message, _this._command);
            } else {
              (0, _output2.default)(message, level, true);
            }
          } catch (e) {
            (0, _output2.default)('Failed to parse server response. Something weird might be happening. Error message: ' + e.message, _handoutConstants.MSG_LEVEL_ERROR);
            (0, _output2.default)('  Raw server response: ' + data);
          }
        });

        _this.socket.on('close', function (code, message) {
          if (code > 1000) {
            (0, _output2.default)('Command failed with code ' + _output.outputStyles.error(code) + '.', _handoutConstants.MSG_LEVEL_ERROR);
          } else {
            (0, _output2.default)('Command completed, closing connection to ' + _output.outputStyles.url(url) + '.', _handoutConstants.MSG_LEVEL_OK);
          }

          if (message) {
            (0, _output2.default)('  Socket close message: ' + message);
          }

          // if (code > 1000) {
          //    process.exit(1)
          // }
        });

        _this.socket.on('error', function (err) {
          return reject(err);
        });
      });
    }
  }, {
    key: 'sendCommand',
    value: function sendCommand(_ref) {
      var command = _ref.command;
      var keyfile = _ref.keyfile;
      var payload = _ref.payload;
      var debug = _ref.debug;
      var username = this.opts.username;

      this._command = command;

      (0, _output2.default)(this.getInfoMessage(command, payload));

      var cryptData = this.getEncryptedCommand(keyfile, { command: command, payload: payload });

      this.socket.send(JSON.stringify({ username: username, debug: debug, cryptData: cryptData }));
    }
  }, {
    key: 'getEncryptedCommand',
    value: function getEncryptedCommand(keyfile, commandSpec) {
      var algorithm = 'aes-256-ctr';
      var outputEncoding = 'base64';
      var privKey = _ursa2.default.createPrivateKey(_fs2.default.readFileSync((0, _expandHomeDir2.default)(keyfile), { encoding: 'utf8' }));
      var secret = _crypto2.default.randomBytes(32).toString('hex');
      var cipher = _crypto2.default.createCipher(algorithm, secret);

      return {
        algorithm: algorithm,
        outputEncoding: outputEncoding,
        secret: privKey.privateEncrypt(secret),
        message: cipher.update(JSON.stringify(commandSpec), 'utf8', outputEncoding) + cipher.final(outputEncoding)
      };
    }
  }, {
    key: 'getInfoMessage',
    value: function getInfoMessage(command, payload) {
      var username = this.opts.username;

      switch (command) {
        case 'deploy':
          var app = payload.app;
          var targets = payload.targets;

          return 'Sending request to deploy ' + _output.outputStyles.app(app) + ' as user ' + _output.outputStyles.username(username) + ' to targets: ' + targets.map(function (t) {
            return _output.outputStyles.target(t);
          }).join(', ') + '.';

        case 'user':
          var action = payload.action;
          var accountname = payload.accountname;

          var targetAccount = _output.outputStyles.target(accountname);

          var msg = new Map([['create', 'to create user ' + targetAccount], ['add-pubkey', 'add public key to account ' + targetAccount], ['remove-pubkey', 'remove public key from account ' + targetAccount], ['remove', 'remove account ' + targetAccount]]);

          return 'Sending request to ' + msg.get(action) + '.';

        case 'user-list':
          return 'Sending request to retrieve user list.';

        case 'permission':
          return 'Sending permission management request.';

        case 'info':
          return 'Sending system information request.';

        default:
          return '[[ Somebody might want to implement an info message for command "' + command + '" ]]';
      }
    }
  }]);

  return WebsocketClient;
}();

exports.default = WebsocketClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ub2RlX21vZHVsZXMvV2Vic29ja2V0Q2xpZW50LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBWU4sZUFBZTtBQUNuQixXQURJLGVBQWUsQ0FDTixJQUFJLEVBQUU7MEJBRGYsZUFBZTs7QUFFakIsUUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUE7QUFDaEIsUUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUE7R0FDckI7O2VBSkcsZUFBZTs7OEJBTVI7OztBQUNULGFBQU8sdUJBQVksVUFBQyxPQUFPLEVBQUUsTUFBTSxFQUFLO1lBQy9CLEdBQUcsR0FBSSxNQUFLLElBQUksQ0FBaEIsR0FBRzs7QUFFVixjQUFLLE1BQU0sR0FBRyxpQkFBYyxHQUFHLENBQUMsQ0FBQTtBQUNoQyxjQUFLLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFO2lCQUFNLE9BQU8sQ0FBQyxNQUFLLE1BQU0sQ0FBQztTQUFBLENBQUMsQ0FBQTs7QUFFbEQsY0FBSyxNQUFNLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFBRSxVQUFDLElBQUksRUFBSztBQUNsQyxjQUFJOzhCQUN5QixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQzs7Z0JBQW5DLEtBQUssZUFBTCxLQUFLO2dCQUFFLE9BQU8sZUFBUCxPQUFPOztBQUV0QixnQkFBSSxLQUFLLHdDQUFzQixFQUFFO0FBQy9CLDJDQUFnQixPQUFPLEVBQUUsTUFBSyxRQUFRLENBQUMsQ0FBQTthQUN4QyxNQUFNO0FBQ0wsb0NBQU8sT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQTthQUM3QjtXQUNGLENBQUMsT0FBTyxDQUFDLEVBQUU7QUFDViwySEFBOEYsQ0FBQyxDQUFDLE9BQU8sb0NBQW9CLENBQUE7QUFDM0gsOERBQWlDLElBQUksQ0FBRyxDQUFBO1dBQ3pDO1NBQ0YsQ0FBQyxD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SSxDQUFDLElBQUksQ0FBQyxPQUFHOztBQUFBLEFBRTVLLGFBQUssTUFBTTtjQUNELE1BQU0sR0FBa0IsT0FBTyxDQUEvQixNQUFNO2NBQUUsV0FBVyxHQUFLLE9BQU8sQ0FBdkIsV0FBVzs7QUFDM0IsY0FBTSxhQUFhLEdBQUcscUJBQWEsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFBOztBQUV0RCxjQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUNsQixDQUFFLFFBQVEsc0JBQW9CLGFBQWEsQ0FBSSxFQUMvQyxDQUFFLFlBQVksaUNBQStCLGFBQWEsQ0FBSSxFQUM5RCxDQUFFLGVBQWUsc0NBQW9DLGFBQWEsQ0FBSSxFQUN0RSxDQUFFLFFBQVEsc0JBQW9CLGFBQWEsQ0FBSSxDQUNoRCxDQUFDLENBQUE7O0FBRUYseUNBQTZCLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLE9BQUc7O0FBQUEsQUFFakQsYUFBSyxXQUFXO0FBQ2QsaUJBQU8sd0NBQXdDLENBQUE7O0FBQUEsQUFFakQsYUFBSyxZQUFZO0FBQ2YsaUJBQU8sd0NBQXdDLENBQUE7O0FBQUEsQUFFakQsYUFBSyxNQUFNO0FBQ1QsaUJBQU8scUNBQXFDLENBQUE7O0FBQUEsQUFFOUM7QUFDRSx1RkFBMkUsT0FBTyxVQUFNO0FBQUEsT0FDM0Y7S0FDRjs7O1NBM0dHLGVBQWU7OztrQkE4R04sZUFBZSIsImZpbGUiOiJXZWJzb2NrZXRDbGllbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCdcblxuaW1wb3J0IFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnXG5pbXBvcnQgY3J5cHRvIGZyb20gJ2NyeXB0bydcbmltcG9ydCBleHBhbmRIb21lRGlyIGZyb20gJ2V4cGFuZC1ob21lLWRpcidcbmltcG9ydCBmcyBmcm9tICdmcydcbmltcG9ydCB7IE1TR19MRVZFTF9FUlJPUiwgTVNHX0xFVkVMX09LLCBNU0dfTEVWRUxfUFJPQ0VTUyB9IGZyb20gJ2hhbmRvdXQtY29uc3RhbnRzJ1xuaW1wb3J0IHVyc2EgZnJvbSAndXJzYSdcbmltcG9ydCBXZWJzb2NrZXQgZnJvbSAnd3MnXG5cbmltcG9ydCBvdXRwdXQsIHsgb3V0cHV0U3R5bGVzLCBwcm9jZXNzUmVzcG9uc2UgfSBmcm9tICdvdXRwdXQnXG5cbmNsYXNzIFdlYnNvY2tldENsaWVudCB7XG4gIGNvbnN0cnVjdG9yIChvcHRzKSB7XG4gICAgdGhpcy5vcHRzID0gb3B0c1xuICAgIHRoaXMuX2NvbW1hbmQgPSBudWxsXG4gIH1cblxuICBjb25uZWN0ICgpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3Qge3VybH0gPSB0aGlzLm9wdHNcblxuICAgICAgdGhpcy5zb2NrZXQgPSBuZXcgV2Vic29ja2V0KHVybClcbiAgICAgIHRoaXMuc29ja2V0Lm9uKCdvcGVuJywgKCkgPT4gcmVzb2x2ZSh0aGlzLnNvY2tldCkpXG5cbiAgICAgIHRoaXMuc29ja2V0Lm9uKCdtZXNzYWdlJywgKGRhdGEpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCB7IGxldmVsLCBtZXNzYWdlIH0gPSBKU09OLnBhcnNlKGRhdGEpXG5cbiAgICAgICAgICBpZiAobGV2ZWwgPT09IE1TR19MRVZFTF9QUk9DRVNTKSB7XG4gICAgICAgICAgICBwcm9jZXNzUmVzcG9uc2UobWVzc2FnZSwgdGhpcy5fY29tbWFuZClcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgb3V0cHV0KG1lc3NhZ2UsIGxldmVsLCB0cnVlKVxuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIG91dHB1dChgRmFpbGVkIHRvIHBhcnNlIHNlcnZlciByZXNwb25zZS4gU29tZXRoaW5nIHdlaXJkIG1pZ2h0IGJlIGhhcHBlbmluZy4gRXJyb3IgbWVzc2FnZTogJHtlLm1lc3NhZ2V9YCwgTVNHX0xFVkVMX0VSUk9SKVxuICAgICAgICAgIG91dHB1dChgICBSYXcgc2VydmVyIHJlc3BvbnNlOiAke2RhdGF9YClcbiAgICAgICAgfVxuICAgICAgfSlcblxuICAgICAgdGhpcy5zb2NrZXQub24oJ2Nsb3NlJywgKGNvZGUsIG1lc3NhZ2UpID0+IHtcbiAgICAgICAgaWYgKGNvZGUgPiAxMDAwKSB7XG4gICAgICAgICAgb3V0cHV0KGBDb21tYW5kIGZhaWxlZCB3aXRoIGNvZGUgJHtvdXRwdXRTdHlsZXMuZXJyb3IoY29kZSl9LmAsIE1TR19MRVZFTF9FUlJPUilcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBvdXRwdXQoYENvbW1hbmQgY29tcGxldGVkLCBjbG9zaW5nIGNvbm5lY3Rpb24gdG8gJHtvdXRwdXRTdHlsZXMudXJsKHVybCl9LmAsIE1TR19MRVZFTF9PSylcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChtZXNzYWdlKSB7XG4gICAgICAgICAgb3V0cHV0KGAgIFNvY2tldCBjbG9zZSBtZXNzYWdlOiAke21lc3NhZ2V9YClcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGlmIChjb2RlID4gMTAwMCkge1xuICAgICAgICAvLyAgICBwcm9jZXNzLmV4aXQoMSlcbiAgICAgICAgLy8gfVxuICAgICAgfSlcblxuICAgICAgdGhpcy5zb2NrZXQub24oJ2Vycm9yJywgZXJyID0+IHJlamVjdChlcnIpKVxuICAgIH0pXG4gIH1cblxuICBzZW5kQ29tbWFuZCAoeyBjb21tYW5kLCBrZXlmaWxlLCBwYXlsb2FkLCBkZWJ1ZyB9KSB7XG4gICAgY29uc3QgeyB1c2VybmFtZSB9ID0gdGhpcy5vcHRzXG4gICAgdGhpcy5fY29tbWFuZCA9IGNvbW1hbmRcblxuICAgIG91dHB1dCh0aGlzLmdldEluZm9NZXNzYWdlKGNvbW1hbmQsIHBheWxvYWQpKVxuXG4gICAgY29uc3QgY3J5cHREYXRhID0gdGhpcy5nZXRFbmNyeXB0ZWRDb21tYW5kKGtleWZpbGUsIHsgY29tbWFuZCwgcGF5bG9hZCB9KVxuXG4gICAgdGhpcy5zb2NrZXQuc2VuZChKU09OLnN0cmluZ2lmeSh7IHVzZXJuYW1lLCBkZWJ1ZywgY3J5cHREYXRhIH0pKVxuICB9XG5cbiAgZ2V0RW5jcnlwdGVkQ29tbWFuZCAoa2V5ZmlsZSwgY29tbWFuZFNwZWMpIHtcbiAgICBjb25zdCBhbGdvcml0aG0gPSAnYWVzLTI1Ni1jdHInXG4gICAgY29uc3Qgb3V0cHV0RW5jb2RpbmcgPSAnYmFzZTY0J1xuICAgIGNvbnN0IHByaXZLZXkgPSB1cnNhLmNyZWF0ZVByaXZhdGVLZXkoZnMucmVhZEZpbGVTeW5jKGV4cGFuZEhvbWVEaXIoa2V5ZmlsZSksIHsgZW5jb2Rpbmc6ICd1dGY4JyB9KSlcbiAgICBjb25zdCBzZWNyZXQgPSBjcnlwdG8ucmFuZG9tQnl0ZXMoMzIpLnRvU3RyaW5nKCdoZXgnKVxuICAgIGNvbnN0IGNpcGhlciA9IGNyeXB0by5jcmVhdGVDaXBoZXIoYWxnb3JpdGhtLCBzZWNyZXQpXG5cbiAgICByZXR1cm4ge1xuICAgICAgYWxnb3JpdGhtLFxuICAgICAgb3V0cHV0RW5jb2RpbmcsXG4gICAgICBzZWNyZXQ6IHByaXZLZXkucHJpdmF0ZUVuY3J5cHQoc2VjcmV0KSxcbiAgICAgIG1lc3NhZ2U6IGNpcGhlci51cGRhdGUoSlNPTi5zdHJpbmdpZnkoY29tbWFuZFNwZWMpLCAndXRmOCcsIG91dHB1dEVuY29kaW5nKSArIGNpcGhlci5maW5hbChvdXRwdXRFbmNvZGluZylcbiAgICB9XG4gIH1cblxuICBnZXRJbmZvTWVzc2FnZSAoY29tbWFuZCwgcGF5bG9hZCkge1xuICAgIGNvbnN0IHt1c2VybmFtZX0gPSB0aGlzLm9wdHNcblxuICAgIHN3aXRjaCAoY29tbWFuZCkge1xuICAgICAgY2FzZSAnZGVwbG95JzpcbiAgICAgICAgY29uc3QgeyBhcHAsIHRhcmdldHMgfSA9IHBheWxvYWRcbiAgICAgICAgcmV0dXJuIGBTZW5kaW5nIHJlcXVlc3QgdG8gZGVwbG95ICR7b3V0cHV0U3R5bGVzLmFwcChhcHApfSBhcyB1c2VyICR7b3V0cHV0U3R5bGVzLnVzZXJuYW1lKHVzZXJuYW1lKX0gdG8gdGFyZ2V0czogJHt0YXJnZXRzLm1hcCh0ID0+IG91dHB1dFN0eWxlcy50YXJnZXQodCkpLmpvaW4oJywgJyl9LmBcblxuICAgICAgY2FzZSAndXNlcic6XG4gICAgICAgIGNvbnN0IHsgYWN0aW9uLCBhY2NvdW50bmFtZSB9ID0gcGF5bG9hZFxuICAgICAgICBjb25zdCB0YXJnZXRBY2NvdW50ID0gb3V0cHV0U3R5bGVzLnRhcmdldChhY2NvdW50bmFtZSlcblxuICAgICAgICBjb25zdCBtc2cgPSBuZXcgTWFwKFtcbiAgICAgICAgICBbICdjcmVhdGUnLCBgdG8gY3JlYXRlIHVzZXIgJHt0YXJnZXRBY2NvdW50fWAgXSxcbiAgICAgICAgICBbICdhZGQtcHVia2V5JywgYGFkZCBwdWJsaWMga2V5IHRvIGFjY291bnQgJHt0YXJnZXRBY2NvdW50fWAgXSxcbiAgICAgICAgICBbICdyZW1vdmUtcHVia2V5JywgYHJlbW92ZSBwdWJsaWMga2V5IGZyb20gYWNjb3VudCAke3RhcmdldEFjY291bnR9YCBdLFxuICAgICAgICAgIFsgJ3JlbW92ZScsIGByZW1vdmUgYWNjb3VudCAke3RhcmdldEFjY291bnR9YCBdXG4gICAgICAgIF0pXG5cbiAgICAgICAgcmV0dXJuIGBTZW5kaW5nIHJlcXVlc3QgdG8gJHttc2cuZ2V0KGFjdGlvbil9LmBcblxuICAgICAgY2FzZSAndXNlci1saXN0JzpcbiAgICAgICAgcmV0dXJuICdTZW5kaW5nIHJlcXVlc3QgdG8gcmV0cmlldmUgdXNlciBsaXN0LidcblxuICAgICAgY2FzZSAncGVybWlzc2lvbic6XG4gICAgICAgIHJldHVybiAnU2VuZGluZyBwZXJtaXNzaW9uIG1hbmFnZW1lbnQgcmVxdWVzdC4nXG5cbiAgICAgIGNhc2UgJ2luZm8nOlxuICAgICAgICByZXR1cm4gJ1NlbmRpbmcgc3lzdGVtIGluZm9ybWF0aW9uIHJlcXVlc3QuJ1xuXG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gYFtbIFNvbWVib2R5IG1pZ2h0IHdhbnQgdG8gaW1wbGVtZW50IGFuIGluZm8gbWVzc2FnZSBmb3IgY29tbWFuZCBcIiR7Y29tbWFuZH1cIiBdXWBcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgV2Vic29ja2V0Q2xpZW50XG4iXX0=