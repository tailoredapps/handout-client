"use strict"

import chalk from 'chalk'
import expandHomeDir from 'expand-home-dir'
import fs from 'fs'
import {inspect} from 'util'
import Promise from 'bluebird'
import ursa from 'ursa'
import ws from 'ws'

import output, {LEVEL_ERROR, LEVEL_INFO, LEVEL_OK, outputStyles} from 'output'

class WebsocketClient {
    constructor(opts) {
        this.opts = opts
    }

    *connect() {
        return new Promise((resolve, reject) => {
            const {url} = this.opts

            this.socket = new ws(url)
            this.socket.on('open', () => resolve(this.socket))

            this.socket.on('message', (data) => {
                try {
                    const {level, message, error} = JSON.parse(data)

                    output(message, error ? LEVEL_ERROR : level, true)
                }
                catch (e) {
                    output(`Failed to parse server response. Something weird might be happening. Error message: ${e.message}`, LEVEL_ERROR)
                    output(`  Raw server response: ${data}`)
                }
            })

            this.socket.on('close', (code, message) => {
                if (code > 1000) {
                    output(`Deployment failed with code ${outputStyles.error(code)}.`, LEVEL_ERROR)
                }
                else {
                    output(`Deployment completed, closing connection to ${outputStyles.url(url)}.`, LEVEL_OK)
                }

                if (message) {
                    output(`  Socket close message: ${message}`)
                }

                //if (code > 1000) {
                //    process.exit(1)
                //}
            })

            this.socket.on('error', err => reject(err))
        })
    }

    *sendCommand(opts) {
        const {username} = this.opts
        const {keyFile, ...cmd} = opts

        output(`Sending request to deploy ${outputStyles.app(cmd.app)} as user ${outputStyles.username(username)} to targets: ${cmd.targets.map(t => outputStyles.target(t)).join(', ')}.`)

        const privKey = ursa.createPrivateKey(fs.readFileSync(expandHomeDir(keyFile), {encoding: 'utf8'}))
        const cryptStr = privKey.privateEncrypt(JSON.stringify(cmd))

        this.socket.send(JSON.stringify({username, cryptStr}))
    }
}

export default WebsocketClient