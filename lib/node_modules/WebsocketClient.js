"use strict"

import Promise from 'bluebird'
import {inspect} from 'util'
import output, {LEVEL_OK, LEVEL_INFO} from 'output'
import ws from 'ws'
import fs from 'fs'
import ursa from 'ursa'
import expandHomeDir from 'expand-home-dir'

class WebsocketClient {
    constructor(opts) {
        this.opts = opts
    }

    *connect() {
        return new Promise((resolve, reject) => {
            const {url} = this.opts

            this.socket = new ws(url)
            this.socket.on('open', () => resolve(this.socket))

            this.socket.on('message', this.handleMessage.bind(this))
            this.socket.on('close', (code, message) => {
                if (code > 1000) {
                    output({
                        error: true,
                        message: `Deployment failed with code ${code}.`
                    })
                }
                else {
                    output({
                        level: LEVEL_OK,
                        message: `Deployment completed, closing connection to ${url}.`
                    })
                }

                //if (code > 1000) {
                //    process.exit(1)
                //}
            })

            this.socket.on('error', err => reject(err))
        })
    }

    *sendCommand(opts) {
        const {username} = this.opts
        const {keyFile, ...cmd} = opts

        output(`Sending request to deploy ${cmd.app} to targets: ${cmd.targets.join(', ')}.`)

        const privKey = ursa.createPrivateKey(fs.readFileSync(expandHomeDir(keyFile), {encoding: 'utf8'}))

        const cryptStr = privKey.privateEncrypt(JSON.stringify(cmd))

        this.socket.send(JSON.stringify({username, cryptStr}))
    }

    handleMessage(data, flags) {
        output(JSON.parse(data))
    }
}

export default WebsocketClient